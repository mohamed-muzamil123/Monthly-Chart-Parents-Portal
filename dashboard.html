<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Parent Dashboard - Hifz Chart Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gradient-to-br from-gray-50 via-white to-gray-100 min-h-screen p-4 sm:p-6"
  >
    <main
      class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-10 border border-gray-200"
    >
      <h1
        class="text-2xl sm:text-3xl font-extrabold text-gray-800 mb-6 text-center"
      >
        Student Dashboard
      </h1>

      <!-- Student Info -->
      <section
        id="studentInfo"
        class="mb-8 p-4 sm:p-6 bg-blue-50 rounded-2xl shadow-inner border border-blue-200 animate-pulse"
      >
        <h2
          class="text-xl sm:text-2xl font-semibold mb-3 text-center text-blue-800"
        >
          Loading student details...
        </h2>
        <div
          class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-w-md mx-auto text-gray-400"
        >
          <div class="h-4 bg-gray-200 rounded w-3/4"></div>
          <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          <div class="h-4 bg-gray-200 rounded w-1/3 sm:col-span-2"></div>
        </div>
      </section>

      <!-- Improvements Section -->
      <section>
        <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-800">
          Improvements History
        </h2>

        <!-- Table for large screens -->
        <div
          class="hidden sm:block overflow-x-auto border border-gray-300 rounded-lg shadow-sm bg-white"
        >
          <table
            class="min-w-full text-gray-700"
            id="improvementsTable"
          ></table>
        </div>

        <!-- Card view for mobile -->
        <div class="sm:hidden space-y-4" id="improvementsCards">
          <!-- Mobile skeletons -->
          <div class="bg-gray-100 animate-pulse h-24 rounded-xl"></div>
          <div class="bg-gray-100 animate-pulse h-24 rounded-xl"></div>
        </div>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBv1446L82JoCaHa_sbsfDh9fb3fVGM2h8",
        authDomain: "hifz-monthly-report.firebaseapp.com",
        databaseURL: "https://hifz-monthly-report-default-rtdb.firebaseio.com",
        projectId: "hifz-monthly-report",
        storageBucket: "hifz-monthly-report.firebasestorage.app",
        messagingSenderId: "303055298705",
        appId: "1:303055298705:web:7098446d7622e580559f30",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const urlParams = new URLSearchParams(window.location.search);
      const admissionNumber = urlParams.get("admissionNumber");

      const studentInfoSection = document.getElementById("studentInfo");
      const improvementsTable = document.getElementById("improvementsTable");
      const improvementsCards = document.getElementById("improvementsCards");

      if (!admissionNumber) {
        studentInfoSection.innerHTML =
          '<p class="text-center text-red-600 font-semibold">Admission Number is missing. Please login again.</p>';
      } else {
        loadStudentData(admissionNumber);
      }

      async function loadStudentData(admNo) {
        try {
          const studentSnap = await get(ref(db, `students/${admNo}`));
          if (!studentSnap.exists()) {
            studentInfoSection.innerHTML =
              '<p class="text-center text-red-600 font-semibold">Student record not found.</p>';
            return;
          }
          const student = studentSnap.val();

          studentInfoSection.classList.remove("animate-pulse");
          studentInfoSection.innerHTML = `
          <h2 class="text-xl sm:text-2xl font-semibold mb-3 text-center text-blue-800">${
            student.name
          } (${student.admissionNumber})</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-gray-700 max-w-md mx-auto text-sm sm:text-base">
            <p><strong>Class:</strong> ${student.class}</p>
            <p><strong>Date of Birth:</strong> ${student.dob}</p>
            <p class="sm:col-span-2"><strong>Current Status:</strong> <span class="${
              student.hafizStatus === "Hafiz"
                ? "text-green-600 font-semibold"
                : "text-yellow-600 font-semibold"
            }">${student.hafizStatus}</span></p>
          </div>
        `;

          loadImprovementsHistory(admNo);
        } catch (error) {
          studentInfoSection.innerHTML = `<p class="text-center text-red-600 font-semibold">Error loading student data: ${error.message}</p>`;
        }
      }

      async function loadImprovementsHistory(admNo) {
        try {
          const improvementsSnap = await get(ref(db, `improvements/${admNo}`));
          if (!improvementsSnap.exists()) {
            improvementsTable.innerHTML = `<tr><td class="p-3 text-center text-gray-400 italic" colspan="6">No improvements records found.</td></tr>`;
            improvementsCards.innerHTML = `<p class="text-center text-gray-400 italic">No improvements records found.</p>`;
            return;
          }

          const data = improvementsSnap.val();
          let rows = [];
          Object.entries(data).forEach(([year, months]) => {
            Object.entries(months).forEach(([month, improvementRec]) => {
              rows.push({
                year: parseInt(year),
                month: parseInt(month),
                improvements: improvementRec,
                status: improvementRec.status || "Not-Hafiz",
              });
            });
          });

          rows.sort((a, b) => a.year - b.year || a.month - b.month);

          // --- Table for desktop ---
          let tableHTML = "";
          let lastStatus = null;
          rows.forEach((row) => {
            if (lastStatus !== null && lastStatus !== row.status) {
              tableHTML += `
              <tr><td colspan="6" class="bg-gray-100 text-center py-1 font-semibold text-gray-600">
                Status changed to ${row.status}
              </td></tr>
            `;
            }
            lastStatus = row.status;

            const monthNames = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            const monthLabel = monthNames[row.month] || `Month ${row.month}`;
            const fields =
              row.status === "Hafiz" ? ["H1", "H2", "H3"] : ["1", "2", "3"];
            const labelHeaders =
              row.status === "Hafiz"
                ? ["H1", "H2", "H3"]
                : ["Improvement 1/H1", "Improvement 2/H2", "Improvement 3/H3"];

            if (!tableHTML.includes("thead") || lastStatus !== row.status) {
              tableHTML += `
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th class="p-2 sm:p-3 text-left font-semibold border-b border-gray-300">Year</th>
                  <th class="p-2 sm:p-3 text-left font-semibold border-b border-gray-300">Month</th>
                  <th class="p-2 sm:p-3 text-left font-semibold border-b border-gray-300">${labelHeaders[0]}</th>
                  <th class="p-2 sm:p-3 text-left font-semibold border-b border-gray-300">${labelHeaders[1]}</th>
                  <th class="p-2 sm:p-3 text-left font-semibold border-b border-gray-300">${labelHeaders[2]}</th>
                  <th class="p-2 sm:p-3 text-left font-semibold border-b border-gray-300">Status</th>
                </tr>
              </thead>
            `;
            }

            tableHTML += `
            <tr class="border-b border-gray-200 hover:bg-gray-50 transition-transform duration-150 hover:scale-[1.01]">
              <td class="p-2 sm:p-3">${row.year}</td>
              <td class="p-2 sm:p-3">${monthLabel}</td>
              <td class="p-2 sm:p-3">${row.improvements[fields[0]] || ""}</td>
              <td class="p-2 sm:p-3">${row.improvements[fields[1]] || ""}</td>
              <td class="p-2 sm:p-3">${row.improvements[fields[2]] || ""}</td>
              <td class="p-2 sm:p-3">
                <span class="px-2 sm:px-3 py-1 rounded-full text-sm font-semibold ${
                  row.status === "Hafiz"
                    ? "bg-green-100 text-green-800"
                    : "bg-yellow-100 text-yellow-800"
                }">${row.status}</span>
              </td>
            </tr>
          `;
          });

          improvementsTable.innerHTML = tableHTML;

          // --- Card view for mobile ---
          let cardsHTML = "";
          rows.forEach((row) => {
            const monthNames = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            const monthLabel = monthNames[row.month] || `Month ${row.month}`;
            const fields =
              row.status === "Hafiz" ? ["H1", "H2", "H3"] : ["1", "2", "3"];

            cardsHTML += `
            <div class="bg-white rounded-xl shadow p-4 border border-gray-200 transition-transform duration-150 hover:scale-[1.02]">
              <div class="flex justify-between items-center mb-2">
                <span class="font-semibold">${monthLabel}, ${row.year}</span>
                <span class="px-2 py-1 rounded-full text-sm font-semibold ${
                  row.status === "Hafiz"
                    ? "bg-green-100 text-green-800"
                    : "bg-yellow-100 text-yellow-800"
                }">${row.status}</span>
              </div>
              <div class="space-y-1 text-gray-700 text-sm">
                <p><strong>${fields[0]}:</strong> ${
              row.improvements[fields[0]] || "-"
            }</p>
                <p><strong>${fields[1]}:</strong> ${
              row.improvements[fields[1]] || "-"
            }</p>
                <p><strong>${fields[2]}:</strong> ${
              row.improvements[fields[2]] || "-"
            }</p>
              </div>
            </div>
          `;
          });

          improvementsCards.innerHTML = cardsHTML;
        } catch (error) {
          improvementsTable.innerHTML = `<tr><td class="p-3 text-center text-red-600 font-semibold" colspan="6">Error loading improvements: ${error.message}</td></tr>`;
          improvementsCards.innerHTML = `<p class="text-center text-red-600 font-semibold">${error.message}</p>`;
        }
      }
    </script>

    <style>
      table th,
      table td {
        word-break: break-word;
      }
      @media (max-width: 640px) {
        .overflow-x-auto {
          overflow-x: auto;
        }
      }
    </style>
  </body>
</html>
